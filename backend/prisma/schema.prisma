generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                       String                @unique
  name                        String?
  passwordHash                String                @map("password_hash")
  isActive                    Boolean               @default(true) @map("is_active")
  createdAt                   DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  lastLogin                   DateTime?             @map("last_login") @db.Timestamptz(6)
  accessRequestsReviewed      AccessRequest[]       @relation("access_request_reviewer")
  aiCFOPlans                  AICFOPlan[]           @relation("plan_createdBy")
  alertRules                  AlertRule[]           @relation("alert_createdBy")
  approvalRequestsApproved    ApprovalRequest[]     @relation("approval_approver")
  approvalRequestsRequested   ApprovalRequest[]     @relation("approval_requester")
  auditLogs                   AuditLog[]            @relation("audit_actor")
  boardReportSchedulesCreated BoardReportSchedule[] @relation("boardSchedule_createdBy")
  budgetsCreated              Budget[]              @relation("budget_createdBy")
  excelMappings               ExcelMapping[]        @relation("excelMapping_createdBy")
  exports                     Export[]              @relation("export_createdBy")
  invitations                 InvitationToken[]     @relation("invitation_createdBy")
  models                      Model[]               @relation("model_createdBy")
  orgSettingsUpdated          OrgSettings[]         @relation("settings_updatedBy")
  prompts                     Prompt[]
  realtimeSimulations         RealtimeSimulation[]
  shareTokens                 ShareToken[]          @relation("shareToken_createdBy")
  roles                       UserOrgRole[]
  preferences                 UserPreferences?
  usageRecords                UserUsage[]

  @@map("users")
}

model Org {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String
  timezone             String                @default("UTC")
  currency             String                @default("USD")
  planTier             String                @default("free") @map("plan_tier")
  dataRegion           String                @default("global") @map("data_region")
  createdAt            DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  accessRequests       AccessRequest[]
  aiCFOPlans           AICFOPlan[]
  alertRules           AlertRule[]
  approvalRequests     ApprovalRequest[]
  auditLogs            AuditLog[]
  billingUsage         BillingUsage[]
  boardReportSchedules BoardReportSchedule[]
  budgets              Budget[]
  chartOfAccounts      ChartOfAccount[]
  computationTraces    ComputationTrace[]
  connectors           Connector[]
  dataImportBatches    DataImportBatch[]
  driverFormulas       DriverFormula[]
  drivers              Driver[]
  excelMappings        ExcelMapping[]
  excelSyncs           ExcelSync[]
  exports              Export[]
  financialLedger      FinancialLedger[]
  financialScenarios   FinancialScenario[]
  forecasts            Forecast[]
  invitationTokens     InvitationToken[]
  jobs                 Job[]
  localizationSettings LocalizationSettings?
  modelRuns            ModelRun[]
  models               Model[]
  monteCarloJobs       MonteCarloJob[]
  notificationChannels NotificationChannel[]
  notifications        Notification[]
  details              OrgDetails?
  quota                OrgQuota?
  settings             OrgSettings?
  prompts              Prompt[]
  provenance           ProvenanceEntry[]
  rawTransactions      RawTransaction[]
  realtimeSimulations  RealtimeSimulation[]
  shareTokens          ShareToken[]
  roles                UserOrgRole[]
  usageRecords         UserUsage[]

  @@map("orgs")
}

model UserOrgRole {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  orgId     String   @db.Uuid
  role      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId])
  @@index([userId])
  @@map("user_org_roles")
}

model Connector {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId              String           @db.Uuid
  type               String
  configJson         Json?            @map("config_json")
  encryptedConfig    Bytes?           @map("encrypted_config")
  status             String           @default("disconnected")
  lastSyncedAt       DateTime?        @map("last_synced_at") @db.Timestamptz(6)
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  syncFrequencyHours Int?             @default(24) @map("sync_frequency_hours")
  autoSyncEnabled    Boolean          @default(true) @map("auto_sync_enabled")
  lastSyncStatus     String?          @map("last_sync_status")
  lastSyncError      String?          @map("last_sync_error")
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  org                Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  rawTransactions    RawTransaction[]

  @@index([orgId])
  @@index([type])
  @@index([autoSyncEnabled, lastSyncedAt])
  @@map("connectors")
}

model RawTransaction {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId         String           @db.Uuid
  connectorId   String?          @db.Uuid
  sourceId      String?          @map("source_id")
  date          DateTime         @db.Date
  amount        Decimal          @db.Decimal(20, 4)
  currency      String           @default("USD")
  category      String?
  description   String?
  rawPayload    Json?            @map("raw_payload")
  importedAt    DateTime         @default(now()) @map("imported_at") @db.Timestamptz(6)
  importBatchId String?          @map("import_batch_id") @db.Uuid
  isDuplicate   Boolean          @default(false) @map("is_duplicate")
  connector     Connector?       @relation(fields: [connectorId], references: [id])
  importBatch   DataImportBatch? @relation(fields: [importBatchId], references: [id])
  org           Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, sourceId])
  @@index([orgId])
  @@index([sourceId])
  @@index([importBatchId])
  @@index([isDuplicate])
  @@index([date])
  @@index([orgId, date], map: "raw_transactions_org_date_idx")
  @@map("raw_transactions")
}

model DataImportBatch {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId           String           @map("org_id") @db.Uuid
  sourceType      String           @map("source_type")
  sourceRef       String?          @map("source_ref")
  fileHash        String?          @map("file_hash")
  mappingJson     Json?            @map("mapping_json")
  statsJson       Json?            @map("stats_json")
  status          String           @default("created")
  createdByUserId String?          @map("created_by_user_id") @db.Uuid
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  org             Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  transactions    RawTransaction[]

  @@index([orgId])
  @@index([sourceType])
  @@index([fileHash])
  @@map("data_import_batches")
}

model ChartOfAccount {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId             String   @db.Uuid
  code              String?
  name              String
  mappedToModelItem String?  @map("mapped_to_model_item")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  org               Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([mappedToModelItem])
  @@map("chart_of_accounts")
}

model Model {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId              String              @db.Uuid
  name               String
  modelJson          Json                @map("model_json")
  createdById        String?             @db.Uuid
  version            Int                 @default(1)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  computationTraces  ComputationTrace[]
  driverFormulas     DriverFormula[]
  drivers            Driver[]
  financialScenarios FinancialScenario[]
  forecasts          Forecast[]
  modelRuns          ModelRun[]
  createdBy          User?               @relation("model_createdBy", fields: [createdById], references: [id])
  org                Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("models")
}

model ModelRun {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelId        String            @db.Uuid
  orgId          String            @db.Uuid
  runType        String            @map("run_type")
  paramsJson     Json?             @map("params_json")
  status         String            @default("queued")
  resultS3       String?           @map("result_s3")
  summaryJson    Json?             @map("summary_json")
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  finishedAt     DateTime?         @map("finished_at") @db.Timestamptz(6)
  aiCFOPlans     AICFOPlan[]
  exports        Export[]
  model          Model             @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org            Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  monteCarloJobs MonteCarloJob[]
  provenance     ProvenanceEntry[]

  @@index([orgId])
  @@index([modelId])
  @@index([status])
  @@index([runType])
  @@map("model_runs")
}

model MonteCarloJob {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId         String    @db.Uuid
  orgId              String    @db.Uuid
  numSimulations     Int       @default(2000) @map("num_simulations")
  paramsHash         String?   @map("params_hash")
  status             String    @default("queued")
  resultS3           String?   @map("result_s3")
  percentilesJson    Json?     @map("percentiles_json")
  cpuSecondsEstimate Decimal?  @map("cpu_seconds_estimate") @db.Decimal
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  finishedAt         DateTime? @map("finished_at") @db.Timestamptz(6)
  sensitivityJson    Json?     @map("sensitivity_json")
  confidenceLevel    Decimal?  @map("confidence_level") @db.Decimal(5, 4)
  cpuSecondsActual   Decimal?  @map("cpu_seconds_actual") @db.Decimal
  modelRun           ModelRun  @relation(fields: [modelRunId], references: [id], onDelete: Cascade)
  org                Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([modelRunId])
  @@index([status])
  @@index([paramsHash])
  @@map("monte_carlo_jobs")
}

model Driver {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId           String          @db.Uuid
  modelId         String          @db.Uuid
  name            String
  description     String?
  type            String
  category        String?
  timeGranularity String          @default("monthly") @map("time_granularity")
  unit            String?
  formula         String?
  isCalculated    Boolean         @default(false) @map("is_calculated")
  version         Int             @default(1)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  formulas        DriverFormula[]
  values          DriverValue[]
  model           Model           @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org             Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([modelId])
  @@map("drivers")
}

model DriverValue {
  id         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId   String            @db.Uuid
  scenarioId String            @db.Uuid
  month      String
  value      Decimal           @db.Decimal(20, 4)
  createdAt  DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  driver     Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)
  scenario   FinancialScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([driverId, scenarioId, month])
  @@index([driverId])
  @@index([scenarioId])
  @@map("driver_values")
}

model FinancialScenario {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId        String        @db.Uuid
  modelId      String        @db.Uuid
  name         String
  color        String?
  isDefault    Boolean       @default(false) @map("is_default")
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  driverValues DriverValue[]
  model        Model         @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([modelId])
  @@map("financial_scenarios")
}

model DriverFormula {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId        String   @db.Uuid
  modelId      String   @db.Uuid
  driverId     String   @db.Uuid
  expression   String
  dependencies Json
  version      Int      @default(1)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  driver       Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  model        Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org          Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([modelId])
  @@map("driver_formulas")
}

model Dimension {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId        String            @db.Uuid
  modelId      String            @db.Uuid
  name         String
  type         String
  displayOrder Int               @default(0) @map("display_order")
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  members      DimensionMember[]

  @@unique([orgId, modelId, name])
  @@index([orgId])
  @@index([modelId])
  @@map("dimensions")
}

model DimensionMember {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  dimensionId  String       @db.Uuid
  name         String
  code         String?
  parentId     String?      @db.Uuid
  level        Int          @default(0)
  displayOrder Int          @default(0) @map("display_order")
  isActive     Boolean      @default(true) @map("is_active")
  metadata     Json?
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  dimension    Dimension    @relation(fields: [dimensionId], references: [id], onDelete: Cascade)
  cubeData     MetricCube[]

  @@unique([dimensionId, name])
  @@index([dimensionId])
  @@index([parentId])
  @@map("dimension_members")
}

model MetricCube {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId        String           @db.Uuid
  modelId      String           @db.Uuid
  metricName   String           @map("metric_name")
  month        String
  geographyId  String?          @db.Uuid
  productId    String?          @db.Uuid
  departmentId String?          @db.Uuid
  segmentId    String?          @db.Uuid
  channelId    String?          @db.Uuid
  scenarioId   String?          @db.Uuid
  customDim1Id String?          @map("custom_dim1_id") @db.Uuid
  customDim2Id String?          @map("custom_dim2_id") @db.Uuid
  value        Decimal          @db.Decimal(20, 4)
  isCalculated Boolean          @default(false) @map("is_calculated")
  formula      String?
  version      Int              @default(1)
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  geography    DimensionMember? @relation(fields: [geographyId], references: [id])

  @@index([orgId, modelId])
  @@index([metricName])
  @@index([month])
  @@index([geographyId])
  @@index([productId])
  @@index([departmentId])
  @@index([segmentId])
  @@index([scenarioId])
  @@map("metric_cube")
}

model Prompt {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId          String?           @db.Uuid
  userId         String?           @db.Uuid
  promptTemplate String?           @map("prompt_template")
  renderedPrompt String?           @map("rendered_prompt")
  responseText   String?           @map("response_text")
  provider       String?
  modelUsed      String?           @map("model_used")
  tokensUsed     Int?              @map("tokens_used")
  cached         Boolean           @default(false)
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  org            Org?              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user           User?             @relation(fields: [userId], references: [id])
  provenance     ProvenanceEntry[]

  @@index([orgId])
  @@index([createdAt])
  @@map("prompts")
}

model ProvenanceEntry {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId      String   @db.Uuid
  orgId           String   @db.Uuid
  cellKey         String   @map("cell_key")
  sourceType      String   @map("source_type")
  sourceRef       Json?    @map("source_ref")
  promptId        String?  @db.Uuid
  confidenceScore Decimal? @map("confidence_score") @db.Decimal(5, 4)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modelRun        ModelRun @relation(fields: [modelRunId], references: [id], onDelete: Cascade)
  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  prompt          Prompt?  @relation(fields: [promptId], references: [id])

  @@index([modelRunId])
  @@index([cellKey])
  @@index([orgId])
  @@index([modelRunId, cellKey])
  @@map("provenance_entries")
}

model Export {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId         String?   @db.Uuid
  orgId              String    @db.Uuid
  type               String
  s3Key              String?   @map("s3_key")
  createdById        String?   @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  status             String    @default("queued")
  provenanceAppendix Json?     @map("provenance_appendix")
  fileData           Bytes?    @map("file_data")
  metaJson           Json?     @map("meta_json")
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy          User?     @relation("export_createdBy", fields: [createdById], references: [id])
  modelRun           ModelRun? @relation(fields: [modelRunId], references: [id])
  org                Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@map("exports")
}

model Job {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobType             String?   @map("job_type")
  orgId               String?   @db.Uuid
  objectId            String?   @map("object_id") @db.Uuid
  status              String    @default("queued")
  progress            Decimal   @default(0) @db.Decimal(5, 2)
  logs                Json?
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  priority            Int       @default(50)
  queue               String?   @default("default")
  attempts            Int       @default(0)
  maxAttempts         Int       @default(5) @map("max_attempts")
  lastError           String?   @map("last_error")
  nextRunAt           DateTime? @map("next_run_at") @db.Timestamptz(6)
  workerId            String?   @map("worker_id")
  runStartedAt        DateTime? @map("run_started_at") @db.Timestamptz(6)
  visibilityExpiresAt DateTime? @map("visibility_expires_at") @db.Timestamptz(6)
  finishedAt          DateTime? @map("finished_at") @db.Timestamptz(6)
  cancelRequested     Boolean   @default(false) @map("cancel_requested")
  createdByUserId     String?   @map("created_by_user_id") @db.Uuid
  billingEstimate     Decimal?  @map("billing_estimate") @db.Decimal(10, 4)
  idempotencyKey      String?   @unique @map("idempotency_key")
  org                 Org?      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([jobType])
  @@index([status])
  @@index([status, priority, createdAt])
  @@index([status, nextRunAt])
  @@index([queue, status])
  @@index([workerId])
  @@index([idempotencyKey])
  @@map("jobs")
}

model BoardReportSchedule {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId              String    @map("org_id") @db.Uuid
  name               String
  template           String
  format             String
  frequency          String    @default("monthly")
  scheduleType       String    @default("single") @map("schedule_type")
  timezone           String    @default("UTC")
  distributionMethod String?   @map("distribution_method")
  recipients         String?
  ccRecipients       String?   @map("cc_recipients")
  status             String    @default("active")
  nextRunAt          DateTime? @map("next_run_at") @db.Timestamptz(6)
  lastRunAt          DateTime? @map("last_run_at") @db.Timestamptz(6)
  metadata           Json?
  createdById        String?   @map("created_by_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy          User?     @relation("boardSchedule_createdBy", fields: [createdById], references: [id])
  org                Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([nextRunAt])
  @@map("board_report_schedules")
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actorUserId String?  @db.Uuid
  orgId       String?  @db.Uuid
  action      String
  objectType  String?  @map("object_type")
  objectId    String?  @map("object_id") @db.Uuid
  metaJson    Json?    @map("meta_json")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  actorUser   User?    @relation("audit_actor", fields: [actorUserId], references: [id])
  org         Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([actorUserId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ShareToken {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String    @db.Uuid
  token       String    @unique
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz(6)
  scope       String    @default("read-only")
  createdById String?   @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   User?     @relation("shareToken_createdBy", fields: [createdById], references: [id])
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
  @@map("share_tokens")
}

model InvitationToken {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String    @db.Uuid
  email       String
  token       String    @unique
  role        String
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt      DateTime? @map("used_at") @db.Timestamptz(6)
  createdById String?   @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   User?     @relation("invitation_createdBy", fields: [createdById], references: [id])
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
  @@index([email])
  @@map("invitation_tokens")
}

model BillingUsage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId      String?  @db.Uuid
  metric     String
  value      Decimal? @db.Decimal
  bucketTime DateTime @map("bucket_time") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  org        Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, metric, bucketTime])
  @@map("billing_usage")
}

model AlertRule {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId         String    @db.Uuid
  name          String
  description   String?
  metric        String
  operator      String
  threshold     Decimal   @db.Decimal(20, 4)
  enabled       Boolean   @default(true)
  notifyEmail   Boolean   @default(false) @map("notify_email")
  notifySlack   Boolean   @default(false) @map("notify_slack")
  slackWebhook  String?   @map("slack_webhook")
  lastTriggered DateTime? @map("last_triggered") @db.Timestamptz(6)
  createdById   String?   @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy     User?     @relation("alert_createdBy", fields: [createdById], references: [id])
  org           Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([enabled])
  @@map("alert_rules")
}

model AICFOPlan {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String    @db.Uuid
  modelRunId  String?   @db.Uuid
  name        String
  description String?
  planJson    Json      @map("plan_json")
  status      String    @default("draft")
  createdById String?   @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   User?     @relation("plan_createdBy", fields: [createdById], references: [id])
  modelRun    ModelRun? @relation(fields: [modelRunId], references: [id])
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@map("ai_cfo_plans")
}

model ComputationTrace {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId         String   @db.Uuid
  modelId       String   @db.Uuid
  triggerNodeId String   @map("trigger_node_id")
  triggerUserId String?  @map("trigger_user_id") @db.Uuid
  affectedNodes Json     @map("affected_nodes")
  durationMs    Int      @map("duration_ms")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  model         Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([modelId])
  @@map("computation_traces")
}

model Forecast {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId          String   @db.Uuid
  modelId        String   @db.Uuid
  metricName     String   @map("metric_name")
  method         String
  forecastData   Json     @map("forecast_data")
  historicalData Json?    @map("historical_data")
  metrics        Json?    @map("metrics")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  model          Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  org            Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([modelId])
  @@map("forecasts")
}

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String    @db.Uuid
  userId    String?   @db.Uuid
  type      String
  title     String
  message   String
  category  String
  priority  String
  read      Boolean   @default(false)
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  metadata  Json?
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationChannel {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId      String   @db.Uuid
  userId     String?  @db.Uuid
  type       String
  enabled    Boolean  @default(true)
  configJson Json?    @map("config_json")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId, type], name: "notification_channel_unique")
  @@index([orgId])
  @@index([userId])
  @@map("notification_channels")
}

model OrgSettings {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId                String   @unique @db.Uuid
  dataRetentionDays    Int      @default(365) @map("data_retention_days")
  currency             String   @default("USD")
  timezone             String   @default("UTC")
  region               String   @default("global")
  updatedById          String?  @db.Uuid
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  complianceJson       Json?    @map("compliance_json")
  securityControlsJson Json?    @map("security_controls_json")
  policiesJson         Json?    @map("policies_json")
  metaJson             Json?    @map("meta_json")
  org                  Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  updatedBy            User?    @relation("settings_updatedBy", fields: [updatedById], references: [id])

  @@map("org_settings")
}

model UserPreferences {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @unique @db.Uuid
  phone          String?
  jobTitle       String?
  bio            String?
  avatarUrl      String?
  appearanceJson Json?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

model OrgDetails {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String   @unique @db.Uuid
  industry    String?
  companySize String?
  website     String?
  address     String?
  taxId       String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("org_details")
}

model LocalizationSettings {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId             String   @unique @db.Uuid
  baseCurrency      String   @default("USD")
  displayCurrency   String   @default("USD")
  language          String   @default("en")
  dateFormat        String   @default("MM/DD/YYYY")
  numberFormat      String   @default("1,234.56")
  timezone          String   @default("UTC")
  autoFxUpdate      Boolean  @default(true)
  fxRatesJson       Json?
  gstEnabled        Boolean  @default(false)
  tdsEnabled        Boolean  @default(false)
  einvoicingEnabled Boolean  @default(false)
  complianceJson    Json?
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  org               Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("localization_settings")
}

model Budget {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  category    String
  month       String
  amount      Decimal  @db.Decimal(20, 4)
  currency    String   @default("USD")
  source      String   @default("manual")
  createdById String?  @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   User?    @relation("budget_createdBy", fields: [createdById], references: [id])
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, category, month])
  @@index([orgId])
  @@index([orgId, month])
  @@index([category])
  @@map("budgets")
}

model ExcelSync {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId        String        @map("org_id") @db.Uuid
  fileName     String?       @map("file_name")
  fileHash     String?       @map("file_hash") @db.VarChar(64)
  mappingId    String?       @map("mapping_id") @db.Uuid
  status       String        @default("pending")
  lastSyncedAt DateTime?     @map("last_synced_at") @db.Timestamptz(6)
  errorMessage String?       @map("error_message")
  metadata     Json?
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  mapping      ExcelMapping? @relation(fields: [mappingId], references: [id])
  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([fileHash])
  @@map("excel_syncs")
}

model ExcelMapping {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String      @map("org_id") @db.Uuid
  name        String
  description String?
  mappingJson Json        @map("mapping_json")
  createdById String?     @map("created_by") @db.Uuid
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   User?       @relation("excelMapping_createdBy", fields: [createdById], references: [id])
  org         Org         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  excelSyncs  ExcelSync[]

  @@index([orgId])
  @@map("excel_mappings")
}

model OrgQuota {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId               String    @unique @map("org_id") @db.Uuid
  monteCarloSimsLimit Int       @default(10000) @map("monte_carlo_sims_limit")
  monteCarloSimsUsed  Int       @default(0) @map("monte_carlo_sims_used")
  monteCarloResetAt   DateTime? @map("monte_carlo_reset_at") @db.Timestamptz(6)
  exportsLimit        Int       @default(100) @map("exports_limit")
  exportsUsed         Int       @default(0) @map("exports_used")
  exportsResetAt      DateTime? @map("exports_reset_at") @db.Timestamptz(6)
  alertsLimit         Int       @default(10) @map("alerts_limit")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  org                 Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("org_quotas")
}

model RealtimeSimulation {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  name          String?  @db.VarChar(255)
  paramsJson    Json     @map("params_json")
  resultsJson   Json     @map("results_json")
  currentMonth  Int      @default(0) @map("current_month")
  isRunning     Boolean  @default(false) @map("is_running")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isSnapshot    Boolean  @default(false) @map("is_snapshot")
  snapshotToken String?  @unique @map("snapshot_token")
  org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([snapshotToken])
  @@index([updatedAt(sort: Desc)])
  @@map("realtime_simulations")
}

model UserUsage {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId           String   @db.Uuid
  userId          String?  @db.Uuid
  simulationRunId String?  @map("simulation_run_id") @db.Uuid
  monteCarloJobId String?  @map("monte_carlo_job_id") @db.Uuid
  creditsUsed     Int      @default(0) @map("credits_used")
  creditType      String   @default("simulation") @map("credit_type")
  description     String?
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id])

  @@index([orgId])
  @@index([userId])
  @@index([orgId, createdAt])
  @@index([simulationRunId])
  @@index([monteCarloJobId])
  @@map("user_usage")
}

model FinancialLedger {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId            String   @db.Uuid
  transactionDate  DateTime @map("transaction_date") @db.Date
  amount           Decimal  @db.Decimal(20, 4)
  currency         String   @default("USD")
  accountCode      String?  @map("account_code")
  accountName      String?  @map("account_name")
  category         String?
  description      String?
  sourceType       String   @map("source_type")
  sourceId         String?  @map("source_id")
  isAdjustment     Boolean  @default(false) @map("is_adjustment")
  adjustmentReason String?  @map("adjustment_reason")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  org              Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([transactionDate])
  @@index([accountCode])
  @@map("financial_ledger")
}

model ApprovalRequest {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String    @db.Uuid
  requesterId String    @db.Uuid
  approverId  String?   @db.Uuid
  status      String    @default("pending")
  type        String
  objectType  String    @map("object_type")
  objectId    String    @map("object_id") @db.Uuid
  payloadJson Json      @map("payload_json")
  comment     String?
  reviewedAt  DateTime? @map("reviewed_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  approver    User?     @relation("approval_approver", fields: [approverId], references: [id])
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  requester   User      @relation("approval_requester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([requesterId])
  @@map("approval_requests")
}

model AccessRequest {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  email       String
  domain      String
  status      String    @default("pending") @db.VarChar(50)
  requestedAt DateTime  @default(now()) @map("requested_at") @db.Timestamptz(6)
  reviewedAt  DateTime? @map("reviewed_at") @db.Timestamptz(6)
  reviewedBy  String?   @map("reviewed_by") @db.Uuid
  message     String?
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reviewer    User?     @relation("access_request_reviewer", fields: [reviewedBy], references: [id])

  @@index([orgId])
  @@index([email])
  @@index([domain])
  @@index([status])
  @@index([orgId, status])
  @@map("access_requests")
}
